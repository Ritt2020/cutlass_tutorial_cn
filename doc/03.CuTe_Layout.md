> CuTe æ˜¯å¤„ç†å¤šç»´æ•°æ®ï¼ˆTensorï¼‰çš„æ¨¡æ¿æŠ½è±¡ã€‚å­¦ä¼šäº† CuTe ä¹‹åï¼Œä½ å°†ä¼šæè¿°ä¸åŒæƒ…å½¢ä¸‹çš„å¤šç»´çŸ©é˜µï¼Œè€Œä¸éœ€è¦å…³æ³¨çŸ©é˜µå†…éƒ¨å…·ä½“å…ƒç´ çš„å­˜å–ä½ç½®ç»†èŠ‚ç­‰ï¼Œä»è€Œåˆ©ç”¨ CUTLASS çš„ç›¸å…³ç‰¹æ€§ã€‚
>
> ğŸ“ **é…å¥—ä»£ç ç¤ºä¾‹**ï¼š[code/03_cute_layout](../code/03_cute_layout)

## ç¯å¢ƒè¦æ±‚
+ CUTLASS 3.x
+ NVCC with C++ 17

## é…ç½®è¯´æ˜
+ **CuTe** æ˜¯ä¸€ä¸ªä»… **header** çš„åº“ã€‚ä½ å¯ä»¥åœ¨ CUTLASS çš„ **include/** æ–‡ä»¶å¤¹ä¸‹æ‰¾åˆ°ã€‚
+ å‚è€ƒä¾‹å­åœ¨ **CUTLASS** ç›®å½•ä¸‹ **examples/cute/** å†…ã€‚

## å¼•å…¥ CuTe
+ å…³é”®ç»„ä»¶å¦‚ä¸‹ï¼š

| ç›®å½• | å†…å®¹ |
| --- | --- |
| [include/cute](https://github.com/NVIDIA/cutlass/tree/main/include/cute) | æ¯ä¸ª header å¯¹åº”äº CuTe çš„åŸºæœ¬ç»„ä»¶ä¹‹ä¸€ï¼Œå¦‚ [Layout](https://github.com/NVIDIA/cutlass/tree/main/include/cute/layout.hpp) å’Œ [Tensor](https://github.com/NVIDIA/cutlass/tree/main/include/cute/tensor.hpp)ã€‚ |
| [include/cute/container](https://github.com/NVIDIA/cutlass/tree/main/include/cute/container) | å®ç°ç±»ä¼¼ STL çš„å¯¹è±¡ï¼Œå¦‚å…ƒç»„ã€æ•°ç»„å’Œå¯¹é½æ•°ç»„ã€‚ |
| [include/cute/numeric](https://github.com/NVIDIA/cutlass/tree/main/include/cute/numeric) | åŸºæœ¬æ•°å­—æ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬éæ ‡å‡†æµ®ç‚¹ç±»å‹ã€éæ ‡å‡†æ•´æ•°ç±»å‹ã€å¤æ•°å’Œæ•´æ•°åºåˆ—ã€‚ |
| [include/cute/algorithm](https://github.com/NVIDIA/cutlass/tree/main/include/cute/algorithm) | å®ç”¨ç¨‹åºç®—æ³•çš„å®ç°ï¼Œå¦‚ copy, fill, clearã€‚ |
| [include/cute/arch](https://github.com/NVIDIA/cutlass/tree/main/include/cute/arch) | ç‰¹å®šæ¶æ„çš„çŸ©é˜µä¹˜æ³•å’Œå¤åˆ¶æŒ‡ä»¤çš„ wrapperã€‚ |
| [include/cute/atom](https://github.com/NVIDIA/cutlass/tree/main/include/cute/atom) | arch/ ç›®å½•çš„å…ƒä¿¡æ¯å’Œåˆ‡åˆ†ã€åˆ†å—ç­‰å·¥å…·ã€‚ |


## æ•°æ®ç±»å‹
### æ•´æ•°ç±»å‹
CuTe æä¾›äº† **åŠ¨æ€** å’Œ **é™æ€** æ•´æ•°ç±»å‹ã€‚

| ç‰¹æ€§ / ç»´åº¦ | åŠ¨æ€æ•´æ•° (run-time integer) | é™æ€æ•´æ•° (compile-time integer) |
| --- | --- | --- |
| C++ ç±»å‹è¡¨ç¤º | æ™®é€šæ•´å‹ï¼Œå¦‚ `int`, `size_t`, `uint16_t` | `std::integral_constant<Value>` æˆ– CuTe çš„ `cute::C<Value>` / `Int<Value>` |
| å€¼ç¡®å®šæ—¶é—´ | è¿è¡Œæ—¶æ‰çŸ¥é“ | ç¼–è¯‘æ—¶å·²çŸ¥å¸¸é‡ |
| ä¸è¿ç®—äº¤äº’ | ä¸é™æ€æ•´æ•°æ··ç”¨ï¼›å¤§å¤šæ•°ç®—æœ¯è¿ç®—åœ¨è¿è¡Œæ—¶æ‰§è¡Œ | æ”¯æŒé‡è½½ç®—æœ¯æ“ä½œï¼Œé™æ€æ•´æ•°è¿ç®—åœ¨ç¼–è¯‘æœŸæŠ˜å ä¸ºé™æ€æ•´æ•° |
| trait / ç±»å‹åˆ¤æ–­ | `cute::is_std_integral<T>` ä¸ºçœŸï¼›`cute::is_integral<T>` ä¸ºçœŸ | `cute::is_static<T>` ä¸ºçœŸï¼›`cute::is_integral<T>` ä¸ºçœŸï¼›ä¹Ÿå¯ç”¨ `cute::is_constant<N, T>` åˆ¤æ–­ |
| å ç”¨ / å­˜å‚¨ | å³æ—¶å€¼ï¼Œå ç”¨å¸¸è§„æ¨¡æ¿å˜é‡æˆ–å†…å­˜ | é€šå¸¸ä¸ºç©ºç±»å‹ï¼Œä¸å è¿è¡Œæ—¶å­˜å‚¨ï¼ˆä½œä¸ºç±»å‹å‚æ•°ï¼‰ |
| åº”ç”¨åœºæ™¯ | å°ºå¯¸ / ç»´åº¦åœ¨è¿è¡Œæ—¶æ‰çŸ¥é“çš„æƒ…å½¢ | Tile å¤§å° / å›ºå®šç»´åº¦ / æ¨¡æ¿å‚æ•°ç­‰å·²çŸ¥å¸¸é‡åœºæ™¯ |
| å¯äº’æ¢æ€§ | åœ¨å¤šæ•° CuTe æ¥å£ä¸­å¯æ›¿æ¢ä¸ºé™æ€æ•´æ•° | åŒæ ·å¯ä»¥æ··ç”¨æˆåŠ¨æ€æ•´æ•°ï¼ˆè½¬æ¢ä¸ºæ™®é€šæ•´å‹ï¼‰ |


### å…ƒç»„ Tuple
+ `cute::tuple`ï¼šCuTe æä¾›çš„å…ƒç»„ç±»å‹ï¼Œå¯åœ¨è®¾å¤‡ï¼ˆCUDA kernelï¼‰å’Œä¸»æœºç«¯ä½¿ç”¨ï¼Œè¡Œä¸ºç±»ä¼¼ `std::tuple`ï¼Œä½†å¯¹æ¨¡æ¿å‚æ•°ç§ç±»æœ‰ä¸€å®šé™åˆ¶ä»¥ä¾¿ç”Ÿæˆæ›´é«˜æ•ˆä»£ç ã€‚  
+ `IntTuple`ï¼šCuTe å®šä¹‰ä¸ºâ€œè¦ä¹ˆæ˜¯ä¸€ä¸ªæ•´æ•°ï¼ˆåŠ¨æ€ / é™æ€ï¼‰ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ª `tuple`ï¼Œå…¶æ¯ä¸ªå…ƒç´ åˆæ˜¯ `IntTuple`ã€‚é€šè¿‡è¿™ä¸ªé€’å½’å®šä¹‰ï¼ŒCuTe èƒ½è¡¨ç¤ºåµŒå¥—ç»“æ„çš„ç»´åº¦ / å½¢çŠ¶ / æ­¥å¹…ç­‰ã€‚  
+ `IntTuple` çš„æ“ä½œåŒ…æ‹¬ï¼š`rank(...)`ï¼ˆå…ƒç´ ä¸ªæ•°ï¼‰ï¼Œ`get<I>(...)`ï¼ˆè®¿é—®ç¬¬ I ä¸ªå…ƒç´ ï¼‰ï¼Œ`depth(...)`ï¼ˆåµŒå¥—æ·±åº¦ï¼‰ï¼Œ`size(...)`ï¼ˆæ‰€æœ‰æ•´æ•°ä¹˜ç§¯ï¼‰ç­‰ã€‚  
+ `Shape`ã€`Stride`ã€`Coord` ç­‰åœ¨ CuTe ä¸­éƒ½è¢«å®šä¹‰ä¸º `IntTuple` çš„åˆ«åæˆ–å®ä¾‹ã€‚

---

#### ç¤ºä¾‹
ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå±•ç¤ºå¦‚ä½•ç”¨ `cute::tuple` / `make_tuple` æ„é€ ä¸€ä¸ªåµŒå¥—çš„ `IntTuple`ï¼Œä»¥åŠå¦‚ä½•è®¿é—®å…¶ä¸­çš„å…ƒç´ ï¼š

```cpp
#include <iostream>
#include "cutlass/experimental/cute/container/tuple.hpp"
using namespace cute;

int main() {
  // ä¸€ä¸ªç®€å•çš„ IntTupleï¼šåŠ¨æ€æ•´æ•° + é™æ€æ•´æ•°çš„ç»„åˆ
  auto t = make_tuple(int{2}, Int<3>{});
  // t è¡¨ç¤º (2, 3)

  // åµŒå¥—ç»“æ„ï¼šç¬¬ä¸‰ä¸ªå…ƒç´ åˆæ˜¯ä¸€ä¸ª tuple
  auto nested = make_tuple(uint16_t{42},
                           make_tuple(Int<1>{}, int{3}),
                           Int<17>{});
  // nested è¡¨ç¤º (42, (1, 3), 17)

  // è®¿é—®å…ƒç´  ä½¿ç”¨ get<index>()
  auto e0 = get<0>(nested);           // e0 æ˜¯ uint16_t{42}
  auto e1 = get<1>(nested);           // e1 æ˜¯ the tuple (Int<1>, int{3})
  auto e1_1 = get<1>(e1);              // e1_1 æ˜¯ int{3}
  auto e2 = get<2>(nested);            // e2 æ˜¯ Int<17>

  std::cout << "e0 = " << int(e0) << "\n";          // æ³¨æ„å¯èƒ½è¦è½¬æ¢ä¸º int æ‰“å°
  std::cout << "e1.second = " << int(e1_1) << "\n";
  std::cout << "e2 (static) = " << Int<17>{}.value << "\n";

  return 0;
}
```

## å¸ƒå±€ Layout
å¸ƒå±€ `Layout` æ˜¯ä¸€å¯¹ `IntTuple`ï¼š`Shape` å’Œ `Stride`ã€‚ç¬¬ä¸€ä¸ªå…ƒç´ å®šä¹‰äº† `Layout` çš„æŠ½è±¡_å½¢çŠ¶_ï¼Œç¬¬äºŒä¸ªå…ƒç´ å®šä¹‰äº†_æ­¥é•¿_ï¼Œä»å½¢çŠ¶å†…çš„åæ ‡æ˜ å°„åˆ°ç´¢å¼•ç©ºé—´ã€‚

æˆ‘ä»¬åœ¨ `Layout` ä¸Šå®šä¹‰äº†è®¸å¤šç±»ä¼¼äº `IntTuple` ä¸Šå®šä¹‰çš„æ“ä½œã€‚

+ `rank(Layout)`ï¼š`Layout` ä¸­çš„æ¨¡å¼æ•°é‡ã€‚ç›¸å½“äº `Layout Shape` çš„å…ƒç»„çš„ `Size`ã€‚
+ `get<I>(Layout)`: `Layout` çš„ç¬¬ `I` ä¸ªå¸ƒå±€æ¨¡å¼ï¼Œ `I < rank`ã€‚
+ `depth(Layout)`ï¼š`Layout` å½¢çŠ¶çš„æ·±åº¦ã€‚å•ä¸ªæ•´æ•°çš„æ·±åº¦ä¸º 0ï¼Œæ•´æ•°å…ƒç»„çš„æ·±åº¦ä¸º 1ï¼Œæ•´æ•°å…ƒç»„çš„æ·±åº¦ä¸º 2ï¼Œç­‰ç­‰ã€‚
+ `shape(Layout)`ï¼š`Layout` çš„**å½¢çŠ¶**ã€‚
+ `stride(Layout)`ï¼š`Layout` çš„**æ­¥é•¿**ã€‚
+ `size(Layout)`ï¼š`Layout` å‡½æ•°åŸŸçš„å¤§å°ã€‚ç­‰åŒäº `size(shape(Layout))`ã€‚
+ `cosize(Layout)`ï¼š`Layout` å‡½æ•°ååŸŸçš„å¤§å°ï¼ˆä¸ä¸€å®šæ˜¯èŒƒå›´ï¼‰ã€‚ç›¸å½“äº `A(size(A)-1)+1`ã€‚è¿™ä¸ªå±æ€§ï¼Œå®é™…ä¸Šä»£è¡¨äº†ä» **stride** æ¨ç†å¾—åˆ°çš„å®é™…ä¸ŠçŸ©é˜µå ç”¨ç©ºé—´ã€‚

### æ„é€ å¸ƒå±€
+ æ„é€ ä¼ å…¥ **shape** å’Œ **stride**ã€‚å¦‚æœä¸ä¼ å…¥ **stride**ï¼Œåˆ™ä¸ºé»˜è®¤ **LayoutLeft**ã€‚
+ **LayoutLeft** ä¸ºä»å·¦åˆ°å³è§£é‡Š **shape**ï¼ˆåˆ—ä¸»åºï¼‰ã€‚**LayoutRight** ä¸ºä»å³åˆ°å·¦è§£é‡Š **shape**ï¼ˆè¡Œä¸»åºï¼‰ã€‚
+ è¿™é‡Œçš„å…³é”®æ˜¯ç†è§£åµŒå¥—çš„ **Layout**ï¼Œå†…å±‚ **Layout** å±•å¼€åä½œä¸ºæ•´ä½“ã€‚

```cpp
// ä¸€ç»´ï¼šå¤§å°ä¸º 8ï¼ˆé™æ€ï¼‰
Layout s8 = make_layout(Int<8>{});   
// ç­‰ä»·äº [8]ï¼Œstride = [1]ï¼Œç¼–è¯‘æœŸå¸¸é‡çš„ä¸€ç»´æ•°ç»„

// ä¸€ç»´ï¼šå¤§å°ä¸º 8ï¼ˆåŠ¨æ€ï¼‰
Layout d8 = make_layout(8);  
// ç­‰ä»·äº [8]ï¼Œstride = [1]ï¼Œè¿è¡Œæ—¶æŒ‡å®šå¤§å°


// äºŒç»´ï¼š2 x 4ï¼Œé™æ€ç»´åº¦ï¼ˆé»˜è®¤åˆ—ä¸»åºï¼‰
Layout s2xs4 = make_layout(make_shape(Int<2>{}, Int<4>{}));  
// shape = [2,4]ï¼Œstride = [1,2]ï¼ˆåˆ—ä¸»åº ColumnMajorï¼‰
// å†…å­˜é¡ºåºï¼šå…ˆå­˜åŒä¸€åˆ—ï¼Œå†å­˜ä¸‹ä¸€åˆ—


// äºŒç»´ï¼š2 x 4ï¼Œæ··åˆé™æ€å’ŒåŠ¨æ€ç»´åº¦
Layout s2xd4 = make_layout(make_shape(Int<2>{}, 4));  
// shape = [2,4]ï¼Œstride = [1,2]ï¼Œä¸ s2xs4 ç­‰ä»·ï¼Œåªæ˜¯ç¬¬äºŒç»´æ˜¯åŠ¨æ€ int


// æŒ‡å®š stride çš„äºŒç»´å¸ƒå±€
Layout s2xd4_a = make_layout(make_shape(Int<2>{}, 4),
                             make_stride(Int<12>{}, Int<1>{}));  
// shape = [2,4], stride = [12,1]
// æ¯è¡Œä¹‹é—´è·¨åº¦ä¸º 12ï¼Œå®é™…æ¯è¡Œåå¤šç•™ 8 ä¸ªç©ºä½


// æŒ‡å®šåˆ—ä¸»åºï¼ˆLayoutLeftï¼‰
Layout s2xd4_col = make_layout(make_shape(Int<2>{}, 4),
                               LayoutLeft{});  
// shape = [2,4]ï¼Œstride = [1,2]ï¼ˆåˆ—ä¸»åº ColumnMajorï¼‰
// å†…å­˜é¡ºåºï¼šå…ˆå­˜ä¸€åˆ—ï¼Œå†å­˜ä¸‹ä¸€åˆ—


// æŒ‡å®šè¡Œä¸»åºï¼ˆLayoutRightï¼‰
Layout s2xd4_row = make_layout(make_shape(Int<2>{}, 4),
                               LayoutRight{});  
// shape = [2,4]ï¼Œstride = [4,1]ï¼ˆè¡Œä¸»åº RowMajorï¼‰
// å†…å­˜é¡ºåºï¼šå…ˆå­˜ä¸€è¡Œï¼Œå†å­˜ä¸‹ä¸€è¡Œ


// å±‚æ¬¡åŒ–å¸ƒå±€ï¼š2 x (2x2)
Layout s2xh4 = make_layout(make_shape(2, make_shape(2,2)),
                           make_stride(4, make_stride(2,1)));  
// shape = [2,2,2]ï¼Œstride = [4,2,1]
// ç­‰ä»·äºä¸€ä¸ª 2x4 çŸ©é˜µï¼Œç”¨åˆ†å±‚å½¢å¼è¡¨ç¤º
// å†…å­˜é¡ºåºï¼šæœ€åä¸¤ç»´ (2x2) è¿ç»­ï¼Œå¤–å±‚æ­¥é•¿ä¸º 4


// ç”¨åˆ—ä¸»åºé‡æ–°è§£é‡Š s2xh4 çš„ shape
Layout s2xh4_col = make_layout(shape(s2xh4),
                               LayoutLeft{});  
// shape = [2,2,2]ï¼Œstride = [1,2,4]ï¼ˆåˆ—ä¸»åºï¼‰
// å†…å­˜é¡ºåºï¼šæœ€å†…å±‚ç»´ stride æœ€å°ï¼Œæœ€å¤–å±‚ç»´ stride æœ€å¤§

```

| Layout | rank | size | cosize | stride | å¤‡æ³¨ |
| --- | --- | --- | --- | --- | --- |
| s8 / d8 | 1 | 8 | 8 | [1] | ä¸€ç»´ |
| s2xs4 | 2 | 8 | 8 | [1,2] | é»˜è®¤ ColumnMajor |
| s2xd4 | 2 | 8 | 8 | [1,2] | åŒä¸Šï¼ˆç¬¬äºŒç»´åŠ¨æ€ï¼‰ |
| s2xd4_a | 2 | 8 | 16 | [12,1] | æœ‰ padding |
| s2xd4_col | 2 | 8 | 8 | [1,2] | ColumnMajor |
| s2xd4_row | 2 | 8 | 8 | [4,1] | RowMajor |
| s2xh4 | 3 | 8 | 8 | [4,2,1] | åˆ†å— 2Ã—(2Ã—2) |
| s2xh4_col | 3 | 8 | 8 | [1,2,4] | ColumnMajor |


å¯ä»¥ä½¿ç”¨ `print2D(), printLayout()` æ‰“å°å¯¹åº”å¸ƒå±€ã€‚

```cpp
> print_layout(s2xs4)
  0    2    4    6
  1    3    5    7
> print_layout(s2xd4_a)
  0    1    2    3
 12   13   14   15
> print_layout(s2xh4_col)
  0    2    4    6
  1    3    5    7
> print_layout(s2xh4)
  0    2    1    3
  4    6    5    7
> print_layout(s2xh4)
(2,(2,2)):(4,(2,1))
      0   1   2   3
    +---+---+---+---+
 0  | 0 | 2 | 1 | 3 |
    +---+---+---+---+
 1  | 4 | 6 | 5 | 7 |
    +---+---+---+---+
```



### ç»ƒä¹ 
+ è¿™é‡Œæ˜¯ä¸€äº›ç»ƒä¹ é¢˜ç›®ï¼Œç”¨äºç†Ÿæ‚‰ Layout çš„å®ç°ã€‚
+ è¯·é’ˆå¯¹æ¯ä¸ªé¢˜ç›®ï¼Œä»”ç»†æ€è€ƒçŸ©é˜µåœ¨äºŒç»´ç©ºé—´å†…çš„å…ƒç´ é¡ºåºæ˜¯æ€ä¹ˆæ ·çš„ã€‚ç„¶åå’Œç­”æ¡ˆå¯¹æ¯”ã€‚

#### é¢˜ç›®
```cpp
auto L = make_layout(Int<4>{});

auto L = make_layout(make_shape(Int<2>{}, Int<3>{}),
                     LayoutRight{});

auto L = make_layout(make_shape(Int<2>{}, Int<3>{}),
                     LayoutLeft{});

auto L = make_layout(make_shape(Int<2>{}, Int<4>{}),
                     make_stride(Int<6>{}, Int<1>{}));

auto L = make_layout(make_shape(2, make_shape(2, 3)),
                     make_stride(6, make_stride(3, 1)));

```

#### ç­”æ¡ˆ

**é¢˜ç›® 1ï¼šä¸€ç»´å¸ƒå±€**
```cpp
auto L = make_layout(Int<4>{});
// shape = [4], stride = [1]
```
```
[0, 1, 2, 3]
```

---

**é¢˜ç›® 2ï¼šè¡Œä¸»åº 2Ã—3**
```cpp
auto L = make_layout(make_shape(Int<2>{}, Int<3>{}), LayoutRight{});
// shape = [2, 3], stride = [3, 1]ï¼ˆè¡Œä¸»åºï¼‰
```
```
[ 0   1   2 ]
[ 3   4   5 ]
```

---

**é¢˜ç›® 3ï¼šåˆ—ä¸»åº 2Ã—3**
```cpp
auto L = make_layout(make_shape(Int<2>{}, Int<3>{}), LayoutLeft{});
// shape = [2, 3], stride = [1, 2]ï¼ˆåˆ—ä¸»åºï¼‰
```
```
[ 0   2   4 ]
[ 1   3   5 ]
```

---

**é¢˜ç›® 4ï¼šå¸¦ padding çš„ 2Ã—4**
```cpp
auto L = make_layout(make_shape(Int<2>{}, Int<4>{}),
                     make_stride(Int<6>{}, Int<1>{}));
// shape = [2, 4], stride = [6, 1]
```
```
[ 0   1   2   3 ]
[ 6   7   8   9 ]   // æ³¨æ„ index=4,5 æ²¡ç”¨åˆ°ï¼ˆpaddingï¼‰
```

---

**é¢˜ç›® 5ï¼šåˆ†å±‚å¸ƒå±€ 2Ã—(2Ã—3)**
```cpp
auto L = make_layout(make_shape(2, make_shape(2, 3)),
                     make_stride(6, make_stride(3, 1)));
// shape = [2, (2, 3)], stride = [6, (3, 1)]
// å¤–å±‚2ä¸ªå—ï¼Œæ¯å—æ˜¯2Ã—3çš„çŸ©é˜µ
```
```
å¤–å±‚å— 0ï¼š
[ 0   1   2 ]
[ 3   4   5 ]

å¤–å±‚å— 1ï¼š
[ 6   7   8 ]
[ 9  10  11 ]
```
æˆ–è€…å±•å¹³ä¸ºä¸€ä¸ª 2Ã—6 çŸ©é˜µï¼š
```
[ 0   3   1   4   2   5 ]
[ 6   9   7   10  8  11 ]
```
### æ‰“å°å¸ƒå±€
æˆ‘ä»¬ä¸ä»…å¯ä»¥é€šè¿‡ `print_layout()` æ¥æ‰“å°å¸ƒå±€ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ `print_latex()` ç›´æ¥è·å– **latex** ä»£ç ç»˜å›¾ã€‚
å¦‚ï¼š
```shell
> print_latex(L5);

% Layout: (2,(2,3)):(6,(3,1))
\documentclass[convert]{standalone}
\usepackage{tikz}

\begin{document}
\begin{tikzpicture}[x={(0cm,-1cm)},y={(1cm,0cm)},every node/.style={minimum size=1cm, outer sep=0pt}]

\node[fill=black!00] at (0,0) {0};
\node[fill=black!60] at (0,1) {3};
\node[fill=black!40] at (0,2) {1};
\node[fill=black!10] at (0,3) {4};
\node[fill=black!20] at (0,4) {2};
\node[fill=black!50] at (0,5) {5};
\node[fill=black!30] at (1,0) {6};
\node[fill=black!40] at (1,1) {9};
\node[fill=black!70] at (1,2) {7};
\node[fill=black!20] at (1,3) {10};
\node[fill=black!00] at (1,4) {8};
\node[fill=black!60] at (1,5) {11};
\draw[color=black,thick,shift={(-0.5,-0.5)}] (0,0) grid (2,6);

\node at (0,-1) {\Large{\texttt{0}}};
\node at (1,-1) {\Large{\texttt{1}}};
\node at (-1,0) {\Large{\texttt{0}}};
\node at (-1,1) {\Large{\texttt{1}}};
\node at (-1,2) {\Large{\texttt{2}}};
\node at (-1,3) {\Large{\texttt{3}}};
\node at (-1,4) {\Large{\texttt{4}}};
\node at (-1,5) {\Large{\texttt{5}}};
\end{tikzpicture}
\end{document}
```

è¾“å‡ºå›¾åƒçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š
![LATEX å›¾åƒ](img/latex_layout_l5.png)

## å¸ƒå±€å…¼å®¹æ€§ (Layout Compatibility)

åœ¨ CuTe ä¸­ï¼Œå¸ƒå±€å…¼å®¹æ€§æ˜¯ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œå®ƒå®šä¹‰äº†ä¸åŒå½¢çŠ¶çš„å¸ƒå±€ä¹‹é—´ä½•æ—¶å¯ä»¥ç›¸äº’è½¬æ¢æˆ–ç»„åˆã€‚

### å®šä¹‰

æˆ‘ä»¬è¯´**å¸ƒå±€ A ä¸å¸ƒå±€ B å…¼å®¹**ï¼Œå½“ä¸”ä»…å½“ A çš„ shape ä¸ B çš„ shape å…¼å®¹ã€‚

**Shape A ä¸ Shape B å…¼å®¹**éœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š

1. A çš„ sizeï¼ˆå…ƒç´ æ€»æ•°ï¼‰ç­‰äº B çš„ size
2. A ä¸­çš„æ‰€æœ‰åæ ‡éƒ½æ˜¯ B ä¸­çš„æœ‰æ•ˆåæ ‡

æ¢å¥è¯è¯´ï¼ŒShape A å¯ä»¥è¢«"é‡æ–°è§£é‡Š"ä¸º Shape Bï¼Œå‰ææ˜¯å®ƒä»¬å…·æœ‰ç›¸åŒçš„å…ƒç´ æ•°é‡ï¼Œå¹¶ä¸” A çš„ç´¢å¼•æ–¹å¼ä¸ä¼šè¶…å‡º B çš„èŒƒå›´ã€‚

### å…¼å®¹æ€§è§„åˆ™

å…¼å®¹æ€§æ˜¯ Shape ä¸Šçš„**å¼±ååºå…³ç³»**ï¼ˆweak partial orderï¼‰ï¼Œå› ä¸ºå®ƒå…·æœ‰ä»¥ä¸‹æ€§è´¨ï¼š

- **è‡ªåæ€§**ï¼ˆReflexiveï¼‰ï¼šä»»ä½• shape éƒ½ä¸è‡ªèº«å…¼å®¹
- **åå¯¹ç§°æ€§**ï¼ˆAntisymmetricï¼‰ï¼šå¦‚æœ A å…¼å®¹ B ä¸” B å…¼å®¹ Aï¼Œåˆ™ A = B
- **ä¼ é€’æ€§**ï¼ˆTransitiveï¼‰ï¼šå¦‚æœ A å…¼å®¹ B ä¸” B å…¼å®¹ Cï¼Œåˆ™ A å…¼å®¹ C

### å…¼å®¹æ€§ç¤ºä¾‹

ä¸‹é¢æ˜¯ä¸€äº›å…·ä½“çš„å…¼å®¹æ€§ç¤ºä¾‹ï¼š

| Shape A | Shape B | å…¼å®¹æ€§ | è¯´æ˜ |
|---------|---------|--------|------|
| `24` | `32` | âŒ ä¸å…¼å®¹ | size ä¸ç›¸ç­‰ï¼ˆ24 â‰  32ï¼‰ |
| `24` | `(4,6)` | âœ… å…¼å®¹ | 24 = 4Ã—6ï¼Œä¸€ç»´å¯ä»¥æ˜ å°„åˆ°äºŒç»´ |
| `(4,6)` | `((2,2),6)` | âœ… å…¼å®¹ | éƒ½æ˜¯ 24 ä¸ªå…ƒç´ ï¼Œ4 å¯ä»¥åˆ†è§£ä¸º (2,2) |
| `((2,2),6)` | `((2,2),(3,2))` | âœ… å…¼å®¹ | éƒ½æ˜¯ 24 ä¸ªå…ƒç´ ï¼Œ6 å¯ä»¥åˆ†è§£ä¸º (3,2) |
| `24` | `((2,2),(3,2))` | âœ… å…¼å®¹ | ä¼ é€’æ€§ï¼š24 â†’ (4,6) â†’ ((2,2),6) â†’ ((2,2),(3,2)) |
| `24` | `((2,3),4)` | âœ… å…¼å®¹ | 24 = 6Ã—4ï¼Œå¯ä»¥é‡ç»„ä¸º (2,3)Ã—4 |
| `((2,3),4)` | `((2,2),(3,2))` | âŒ ä¸å…¼å®¹ | è™½ç„¶ size ç›¸åŒï¼Œä½†ç»´åº¦ç»“æ„ä¸åŒ¹é… |
| `((2,2),(3,2))` | `((2,3),4)` | âŒ ä¸å…¼å®¹ | åè¿‡æ¥ä¹Ÿä¸å…¼å®¹ |
| `24` | `(24)` | âœ… å…¼å®¹ | æ•´æ•°å¯ä»¥å˜æˆå•å…ƒç´  tuple |
| `(24)` | `24` | âŒ ä¸å…¼å®¹ | tuple ä¸èƒ½ç›´æ¥å˜å›æ•´æ•° |
| `(24)` | `(4,6)` | âŒ ä¸å…¼å®¹ | rank ä¸åŒ¹é… |

### ç†è§£å…¼å®¹æ€§

**ä¸ºä»€ä¹ˆ `((2,3),4)` ä¸ `((2,2),(3,2))` ä¸å…¼å®¹ï¼Ÿ**

è™½ç„¶ä¸¤è€…çš„ size éƒ½æ˜¯ 24ï¼ˆ2Ã—3Ã—4 = 2Ã—2Ã—3Ã—2ï¼‰ï¼Œä½†å®ƒä»¬çš„å±‚æ¬¡ç»“æ„ä¸åŒï¼š

- `((2,3),4)` çš„ç»“æ„ï¼šå¤–å±‚ (2,3) æ˜¯ 6 ä¸ªå…ƒç´ ï¼Œå†…å±‚ 4 ä¸ªå…ƒç´ 
- `((2,2),(3,2))` çš„ç»“æ„ï¼šå¤–å±‚ (2,2) æ˜¯ 4 ä¸ªå…ƒç´ ï¼Œå†…å±‚ (3,2) æ˜¯ 6 ä¸ªå…ƒç´ 

è¿™ä¸¤ç§ç»“æ„çš„ç´¢å¼•æ–¹å¼ä¸åŒï¼Œæ— æ³•ç›´æ¥æ˜ å°„ã€‚

**ä¸ºä»€ä¹ˆ `(24)` ä¸ `24` ä¸å…¼å®¹ï¼Ÿ**

- `24` æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºä¸€ç»´æ•°ç»„
- `(24)` æ˜¯ä¸€ä¸ªåŒ…å«å•ä¸ªæ•´æ•°çš„ tupleï¼Œrank = 1
- å®ƒä»¬åœ¨ CuTe çš„ç±»å‹ç³»ç»Ÿä¸­æ˜¯ä¸åŒçš„ç±»å‹

### å…¼å®¹æ€§æ£€æŸ¥

åœ¨ CuTe ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼æ£€æŸ¥å…¼å®¹æ€§ï¼š

```cpp
// åˆ›å»ºä¸åŒçš„ shape
auto s1 = make_shape(24);
auto s2 = make_shape(Int<4>{}, Int<6>{});
auto s3 = make_shape(make_shape(Int<2>{}, Int<2>{}), Int<6>{});

// size æ£€æŸ¥
static_assert(size(s1) == size(s2), "Size must match");
static_assert(size(s2) == size(s3), "Size must match");

// å…¼å®¹çš„å¸ƒå±€å¯ä»¥ç›¸äº’è½¬æ¢
auto layout1 = make_layout(s1);
auto layout2 = make_layout(s2);
// å¯ä»¥ä½¿ç”¨ s1 çš„åæ ‡è®¿é—® layout2ï¼ˆé€šè¿‡çº¿æ€§åŒ–ï¼‰
```

### å®é™…åº”ç”¨

å¸ƒå±€å…¼å®¹æ€§åœ¨ä»¥ä¸‹åœºæ™¯ä¸­éå¸¸é‡è¦ï¼š

1. **å¼ é‡é‡å¡‘ï¼ˆReshapeï¼‰**ï¼šå°†ä¸€ç»´æ•°æ®é‡æ–°è§£é‡Šä¸ºå¤šç»´å¼ é‡
2. **åˆ†å—ï¼ˆTilingï¼‰**ï¼šå°†å¤§çŸ©é˜µåˆ†è§£ä¸ºå°å—è¿›è¡Œå¤„ç†
3. **æ•°æ®è½¬æ¢**ï¼šåœ¨ä¸åŒçš„å†…å­˜å¸ƒå±€ä¹‹é—´è½¬æ¢
4. **å±‚æ¬¡åŒ–å¤„ç†**ï¼šå°†æ‰å¹³æ•°æ®ç»„ç»‡æˆå±‚æ¬¡ç»“æ„

ä¾‹å¦‚ï¼Œåœ¨ GEMM ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å°†ä¸€ä¸ª `MÃ—N` çš„çŸ©é˜µåˆ†å—ä¸º `(BlockM, TileM) Ã— (BlockN, TileN)` çš„å±‚æ¬¡åŒ–ç»“æ„ï¼Œè¿™å°±éœ€è¦ç¡®ä¿å½¢çŠ¶çš„å…¼å®¹æ€§ã€‚